<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Our Apartment Planner</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --blue: #1a3a6b;
    --blue2: #1e4080;
    --blue-light: #2d5aa0;
    --blue-pale: #e8eef8;
    --blue-dim: rgba(26,58,107,0.08);
    --red: #c0392b;
    --red-light: #e74c3c;
    --red-pale: #fdf0ef;
    --red-dim: rgba(192,57,43,0.1);
    --white: #ffffff;
    --off-white: #f7f9fc;
    --bg: #f0f4f9;
    --text: #1a2a3a;
    --muted: #6b7e96;
    --border: rgba(26,58,107,0.15);
    --border2: rgba(26,58,107,0.1);
    --card: #ffffff;
    --green: #1a7a4a;
    --green-pale: #eaf4ee;
    --shadow: 0 2px 12px rgba(26,58,107,0.1);
    --shadow-hover: 0 6px 24px rgba(26,58,107,0.16);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-weight: 400;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ PAGE WRAPPER ‚Äî centers everything on wide screens ‚îÄ‚îÄ */
  .page-wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
  #setup-screen {
    display: none;
    position: fixed; inset: 0;
    background: var(--bg);
    z-index: 9000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    padding: 40px;
  }
  #setup-screen.visible { display: flex; }
  #setup-screen h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2rem;
    color: var(--blue);
    margin-bottom: 8px;
  }
  #setup-screen p { color: var(--muted); font-size: 0.9rem; max-width: 460px; text-align: center; line-height: 1.6; }
  .setup-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 36px;
    width: 100%;
    max-width: 480px;
    margin-top: 8px;
    box-shadow: var(--shadow);
  }
  .setup-box label { display: block; font-size: 0.72rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .setup-box input {
    width: 100%; background: var(--off-white); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem; padding: 11px 14px; outline: none; transition: border-color 0.15s;
    margin-bottom: 16px;
  }
  .setup-box input:focus { border-color: var(--blue); }
  .setup-note { font-size: 0.78rem; color: var(--muted); background: var(--blue-dim); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; line-height: 1.6; margin-bottom: 16px; }
  .setup-note code { color: var(--blue); font-size: 0.82rem; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: var(--blue);
    color: white;
    padding: 0;
    border-bottom: 4px solid var(--red);
  }
  .header-inner {
    max-width: 1100px;
    margin: 0 auto;
    padding: 22px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 14px;
  }
  .header-left h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2rem;
    font-weight: 400;
    color: white;
    line-height: 1;
  }
  .header-left h1 em { color: #f4d06f; font-style: italic; }
  .subtitle { font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(255,255,255,0.6); margin-top: 4px; }

  /* EDIT MODE TOGGLE */
  .edit-toggle-wrap { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  #edit-status {
    font-size: 0.7rem; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 5px 12px; border-radius: 20px; border: 1px solid;
    transition: all 0.2s;
  }
  #edit-status.locked { color: rgba(255,255,255,0.5); border-color: rgba(255,255,255,0.2); }
  #edit-status.unlocked { color: #f4d06f; border-color: #f4d06f; background: rgba(244,208,111,0.15); }
  .btn-lock {
    background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.25); color: white;
    font-family: 'DM Sans', sans-serif; font-size: 0.75rem; letter-spacing: 0.07em;
    text-transform: uppercase; padding: 7px 16px; border-radius: 8px; cursor: pointer;
    transition: all 0.2s;
  }
  .btn-lock:hover { background: rgba(255,255,255,0.22); }

  /* SUPABASE STATUS DOT */
  .db-status {
    display: flex; align-items: center; gap: 6px;
    font-size: 0.7rem; color: rgba(255,255,255,0.5); letter-spacing: 0.06em;
  }
  .db-dot { width: 7px; height: 7px; border-radius: 50%; background: rgba(255,255,255,0.3); transition: background 0.3s; }
  .db-dot.connected { background: #4cdf8a; box-shadow: 0 0 6px #4cdf8a; }
  .db-dot.error { background: #ff6b6b; }
  .db-dot.saving { background: #f4d06f; animation: pulse 0.8s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  nav {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 1px 4px rgba(26,58,107,0.07);
  }
  .nav-inner {
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  .nav-inner::-webkit-scrollbar { display: none; }
  nav button {
    background: none; border: none; color: var(--muted);
    font-family: 'DM Sans', sans-serif; font-size: 0.8rem;
    font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase;
    padding: 14px 18px; cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s; white-space: nowrap; flex-shrink: 0;
  }
  nav button:hover { color: var(--blue); }
  nav button.active { color: var(--blue); border-bottom-color: var(--red); }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  main {
    max-width: 1100px;
    margin: 0 auto;
    padding: 28px 24px 60px;
  }

  /* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
  .section-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 22px; flex-wrap: wrap; gap: 12px;
  }
  .section-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.7rem; font-weight: 400; color: var(--blue);
  }
  .section-title small {
    display: block; font-family: 'DM Sans', sans-serif;
    font-size: 0.68rem; color: var(--muted);
    letter-spacing: 0.1em; text-transform: uppercase; margin-top: 3px;
  }

  /* ‚îÄ‚îÄ SUMMARY BAR ‚îÄ‚îÄ */
  .summary-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }
  .sum-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 18px;
    box-shadow: var(--shadow);
  }
  .sum-label { font-size: 0.66rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .sum-value { font-family: 'Cormorant Garamond', serif; font-size: 1.7rem; font-weight: 400; color: var(--blue); }
  .sum-value.gold { color: var(--blue2); }
  .sum-value.green { color: var(--green); }
  .sum-value.red { color: var(--red); }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px; margin-bottom: 24px;
  }
  .card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative; box-shadow: var(--shadow);
  }
  .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }

  .card-header {
    display: flex; align-items: center; gap: 14px;
    padding: 18px 18px 14px;
    border-bottom: 1px solid var(--border2);
    background: var(--blue-pale);
  }
  .company-logo {
    width: 48px; height: 48px; border-radius: 10px;
    background: white; border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    overflow: hidden; flex-shrink: 0;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }
  .company-logo img { width: 100%; height: 100%; object-fit: contain; }
  .company-logo .initials {
    font-family: 'Cormorant Garamond', serif; font-size: 1.2rem;
    color: var(--blue); font-weight: 600;
  }
  .card-name { font-size: 1rem; font-weight: 500; color: var(--blue); }
  .card-tag { font-size: 0.66rem; color: var(--muted); letter-spacing: 0.07em; text-transform: uppercase; margin-top: 2px; }
  .card-body { padding: 14px 18px; }
  .price-row {
    display: flex; justify-content: space-between; align-items: baseline;
    margin-bottom: 8px;
  }
  .price-label { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }
  .price-value { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; color: var(--blue2); font-weight: 400; }
  .note-text { font-size: 0.8rem; color: var(--muted); line-height: 1.55; margin-top: 8px; }
  .card-actions {
    display: flex; gap: 8px; align-items: center;
    padding: 10px 18px;
    border-top: 1px solid var(--border2);
    background: var(--off-white);
  }
  .badge-fav {
    position: absolute; top: 10px; right: 10px;
    background: var(--red); color: white;
    font-size: 0.56rem; font-weight: 500;
    letter-spacing: 0.1em; text-transform: uppercase;
    padding: 3px 8px; border-radius: 20px;
  }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn-add {
    display: inline-flex; align-items: center; gap: 7px;
    background: var(--red); border: none;
    color: white; font-family: 'DM Sans', sans-serif;
    font-size: 0.75rem; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 10px 20px; border-radius: 8px; cursor: pointer;
    transition: all 0.2s; box-shadow: 0 2px 8px rgba(192,57,43,0.25);
  }
  .btn-add:hover { background: var(--red-light); box-shadow: 0 4px 12px rgba(192,57,43,0.3); }
  .btn-add:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-small {
    font-family: 'DM Sans', sans-serif; font-size: 0.68rem;
    font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase;
    padding: 5px 11px; border-radius: 6px; border: 1px solid;
    cursor: pointer; transition: all 0.15s;
  }
  .btn-edit { background: transparent; border-color: var(--border); color: var(--muted); }
  .btn-edit:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-pale); }
  .btn-delete { background: transparent; border-color: transparent; color: var(--muted); }
  .btn-delete:hover { color: var(--red); border-color: rgba(192,57,43,0.25); background: var(--red-pale); }
  .btn-fav { background: transparent; border-color: transparent; color: var(--muted); margin-left: auto; font-size: 1rem; }
  .btn-fav.active { color: var(--red); }
  .btn-fav:hover { color: var(--red-light); }
  .btn-primary {
    width: 100%; background: var(--blue); color: white; border: none;
    border-radius: 8px; font-family: 'DM Sans', sans-serif;
    font-size: 0.82rem; font-weight: 500; letter-spacing: 0.08em;
    text-transform: uppercase; padding: 13px; cursor: pointer;
    margin-top: 8px; transition: background 0.15s;
    box-shadow: 0 2px 8px rgba(26,58,107,0.2);
  }
  .btn-primary:hover { background: var(--blue2); }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(15,30,60,0.5); backdrop-filter: blur(4px);
    z-index: 1000; align-items: center; justify-content: center; padding: 16px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: white; border: 1px solid var(--border);
    border-radius: 16px; width: 100%; max-width: 520px; padding: 30px;
    position: relative; animation: slideUp 0.22s ease;
    max-height: 92vh; overflow-y: auto;
    box-shadow: 0 20px 60px rgba(26,58,107,0.2);
  }
  @keyframes slideUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
  .modal h2 {
    font-family: 'Cormorant Garamond', serif; font-size: 1.5rem;
    font-weight: 400; color: var(--blue); margin-bottom: 20px;
    padding-bottom: 14px; border-bottom: 2px solid var(--red);
  }
  .modal-close {
    position: absolute; top: 16px; right: 16px;
    background: none; border: none; color: var(--muted);
    font-size: 1.3rem; cursor: pointer; transition: color 0.15s; line-height: 1;
    width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
  }
  .modal-close:hover { color: var(--red); background: var(--red-pale); }
  .form-group { margin-bottom: 14px; }
  .form-group label {
    display: block; font-size: 0.7rem; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--muted); margin-bottom: 5px; font-weight: 500;
  }
  .form-group input, .form-group textarea, .form-group select {
    width: 100%; background: var(--off-white); border: 1.5px solid var(--border);
    border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif;
    font-size: 0.92rem; padding: 10px 13px; outline: none; transition: border-color 0.15s;
  }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    border-color: var(--blue); background: white;
  }
  .form-group textarea { resize: vertical; min-height: 76px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  /* ‚îÄ‚îÄ EXPENSE LIST ‚îÄ‚îÄ */
  .expense-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
  .expense-item {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 16px;
    display: flex; align-items: center; gap: 12px;
    transition: box-shadow 0.2s; box-shadow: var(--shadow);
  }
  .expense-item:hover { box-shadow: var(--shadow-hover); }
  .expense-icon {
    width: 40px; height: 40px; border-radius: 10px;
    background: var(--blue-pale); display: flex; align-items: center;
    justify-content: center; font-size: 1.15rem; flex-shrink: 0;
  }
  .expense-info { flex: 1; min-width: 0; }
  .expense-name { font-size: 0.94rem; color: var(--text); font-weight: 500; }
  .expense-cat { font-size: 0.66rem; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; margin-top: 2px; }
  .expense-amount { font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; color: var(--blue2); text-align: right; white-space: nowrap; font-weight: 400; }
  .expense-freq { font-size: 0.64rem; color: var(--muted); display: block; text-align: right; }
  .item-actions { display: flex; flex-direction: column; gap: 5px; flex-shrink: 0; }

  /* ‚îÄ‚îÄ LOAN ‚îÄ‚îÄ */
  .loan-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 24px; margin-bottom: 16px;
    box-shadow: var(--shadow);
  }
  .loan-card h3 {
    font-family: 'Cormorant Garamond', serif; font-size: 1.3rem;
    color: var(--blue); margin-bottom: 16px;
    padding-bottom: 12px; border-bottom: 1px solid var(--border);
  }
  .loan-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 14px; }
  .loan-stat .l-label { font-size: 0.66rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
  .loan-stat .l-val { font-family: 'Cormorant Garamond', serif; font-size: 1.45rem; color: var(--blue2); margin-top: 3px; }
  .progress-wrap { margin-top: 18px; }
  .progress-label { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--muted); margin-bottom: 6px; }
  .progress-bar { height: 6px; background: var(--blue-pale); border-radius: 4px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--blue-light)); border-radius: 4px; transition: width 0.5s ease; }

  /* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
  .chart-wrap {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 22px; margin-bottom: 24px;
    box-shadow: var(--shadow);
  }
  .chart-title { font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; color: var(--blue); margin-bottom: 16px; }
  .bar-chart { display: flex; align-items: flex-end; gap: 8px; height: 120px; }
  .bar-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 0; }
  .bar { width: 100%; border-radius: 4px 4px 0 0; background: linear-gradient(180deg, var(--blue-light), var(--blue)); min-height: 3px; transition: height 0.4s ease; }
  .bar.loan-bar { background: linear-gradient(180deg, var(--red-light), var(--red)); }
  .bar-label { font-size: 0.58rem; color: var(--muted); text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }
  .bar-val { font-size: 0.6rem; color: var(--blue); font-weight: 500; }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty-state { text-align: center; padding: 52px 20px; color: var(--muted); }
  .empty-state .big-icon { font-size: 2.8rem; margin-bottom: 14px; opacity: 0.4; }
  .empty-state p { font-size: 0.88rem; line-height: 1.6; }

  /* ‚îÄ‚îÄ PASSWORD MODAL ‚îÄ‚îÄ */
  #modal-password .modal { max-width: 380px; }
  .pw-error { color: var(--red); font-size: 0.8rem; margin-top: 6px; display: none; }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(16px);
    background: var(--blue); border: none;
    color: white; font-size: 0.82rem; letter-spacing: 0.03em;
    padding: 10px 22px; border-radius: 30px;
    box-shadow: 0 4px 16px rgba(26,58,107,0.3); opacity: 0;
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none; z-index: 9999; white-space: nowrap;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ */
  #loading {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px; z-index: 8000;
    transition: opacity 0.4s;
  }
  #loading.done { opacity: 0; pointer-events: none; }
  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--blue);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading p { font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; color: var(--muted); }

  /* RESPONSIVE */
  @media (max-width: 640px) {
    .header-inner { padding: 16px; }
    .header-left h1 { font-size: 1.5rem; }
    main { padding: 18px 14px 60px; }
    .nav-inner { padding: 0 14px; }
    nav button { padding: 12px 12px; font-size: 0.72rem; }
    .cards-grid { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
    .summary-bar { grid-template-columns: 1fr 1fr; }
    .expense-item { flex-wrap: wrap; }
    .item-actions { flex-direction: row; }
    .modal { padding: 20px 16px; }
    #edit-status { display: none; }
  }

  /* hide edit controls when locked */
  body.locked .edit-only { display: none !important; }
</style>
</head>
<body class="locked">

<!-- LOADING -->
<div id="loading">
  <div class="spinner"></div>
  <p>Loading your planner‚Ä¶</p>
</div>

<!-- SETUP SCREEN -->
<div id="setup-screen">
  <div>
    <h2>Connect to Supabase</h2>
    <p>Enter your Supabase project credentials below. You only need to do this once ‚Äî they'll be saved in the browser.</p>
  </div>
  <div class="setup-box">
    <div class="setup-note">
      1. Go to <code>supabase.com</code> ‚Üí New project<br>
      2. Settings ‚Üí API ‚Üí copy <code>Project URL</code> and <code>anon public key</code><br>
      3. In the SQL editor, run the setup SQL from the included <code>SETUP.sql</code> file
    </div>
    <label>Supabase Project URL</label>
    <input type="text" id="setup-url" placeholder="https://xxxxxxxxxxxx.supabase.co">
    <label>Supabase Anon Key</label>
    <input type="text" id="setup-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
    <button class="btn-primary" onclick="saveSetup()">Connect & Save</button>
  </div>
</div>

<!-- PASSWORD MODAL -->
<div class="modal-overlay" id="modal-password">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('password')">‚úï</button>
    <h2>Enter Edit Mode</h2>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="pw-input" placeholder="Enter password" onkeydown="if(event.key==='Enter')checkPassword()">
      <div class="pw-error" id="pw-error">Incorrect password</div>
    </div>
    <button class="btn-primary" onclick="checkPassword()">Unlock Editing</button>
  </div>
</div>

<!-- KITCHEN MODAL -->
<div class="modal-overlay" id="modal-kitchen">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('kitchen')">‚úï</button>
    <h2 id="kitchen-modal-title">Add Kitchen Company</h2>
    <input type="hidden" id="k-edit-id">
    <div class="form-row">
      <div class="form-group">
        <label>Company Name</label>
        <input type="text" id="k-name" placeholder="e.g. IKEA, Nobilia‚Ä¶">
      </div>
      <div class="form-group">
        <label>Logo Image URL</label>
        <input type="text" id="k-logo" placeholder="https://‚Ä¶/logo.png">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Price (‚Ç¨)</label>
        <input type="number" id="k-price" placeholder="15000">
      </div>
      <div class="form-group">
        <label>Style / Type</label>
        <input type="text" id="k-style" placeholder="Modern, classic‚Ä¶">
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="k-notes" placeholder="Delivery time, what's included, impressions‚Ä¶"></textarea>
    </div>
    <div class="form-group">
      <label>Contact / Showroom</label>
      <input type="text" id="k-contact" placeholder="Showroom address or salesperson name">
    </div>
    <div class="form-group">
      <label>Website</label>
      <input type="text" id="k-website" placeholder="https://company.com">
    </div>
    <button class="btn-primary" onclick="saveKitchen()">Save Company</button>
  </div>
</div>

<!-- ONE-OFF MODAL -->
<div class="modal-overlay" id="modal-oneoff">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('oneoff')">‚úï</button>
    <h2 id="oneoff-modal-title">Add One-off Cost</h2>
    <input type="hidden" id="o-edit-id">
    <div class="form-row">
      <div class="form-group">
        <label>Item Name</label>
        <input type="text" id="o-name" placeholder="e.g. Sofa, Flooring‚Ä¶">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="o-cat">
          <option value="furniture">üõãÔ∏è Furniture</option>
          <option value="appliances">üîå Appliances</option>
          <option value="renovation">üî® Renovation</option>
          <option value="flooring">üè† Flooring</option>
          <option value="lighting">üí° Lighting</option>
          <option value="textiles">üõèÔ∏è Textiles</option>
          <option value="storage">üì¶ Storage</option>
          <option value="other">üìã Other</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Budget (‚Ç¨)</label>
        <input type="number" id="o-budget" placeholder="2000">
      </div>
      <div class="form-group">
        <label>Actual / Expected Cost (‚Ç¨)</label>
        <input type="number" id="o-actual" placeholder="1850">
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="o-notes" placeholder="Store, delivery date, decisions pending‚Ä¶"></textarea>
    </div>
    <button class="btn-primary" onclick="saveOneoff()">Save Cost</button>
  </div>
</div>

<!-- LOAN MODAL -->
<div class="modal-overlay" id="modal-loan">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('loan')">‚úï</button>
    <h2>Loan / Mortgage Details</h2>
    <div class="form-row">
      <div class="form-group">
        <label>Lender</label>
        <input type="text" id="l-name" placeholder="e.g. LHV, SEB, Swedbank">
      </div>
      <div class="form-group">
        <label>Total Loan Amount (‚Ç¨)</label>
        <input type="number" id="l-amount" placeholder="200000">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Monthly Payment (‚Ç¨)</label>
        <input type="number" id="l-monthly" placeholder="950">
      </div>
      <div class="form-group">
        <label>Interest Rate (%)</label>
        <input type="number" id="l-rate" step="0.01" placeholder="3.5">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Term (years)</label>
        <input type="number" id="l-term" placeholder="25">
      </div>
      <div class="form-group">
        <label>Amount Paid So Far (‚Ç¨)</label>
        <input type="number" id="l-paid" placeholder="0">
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="l-notes" placeholder="Fixed/variable rate, special conditions‚Ä¶"></textarea>
    </div>
    <button class="btn-primary" onclick="saveLoan()">Save Loan</button>
  </div>
</div>

<!-- MONTHLY MODAL -->
<div class="modal-overlay" id="modal-monthly">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('monthly')">‚úï</button>
    <h2 id="monthly-modal-title">Add Monthly Expense</h2>
    <input type="hidden" id="m-edit-id">
    <div class="form-row">
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="m-name" placeholder="e.g. Electricity, Netflix‚Ä¶">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="m-cat">
          <option value="utilities">‚ö° Utilities</option>
          <option value="food">üõí Food & Groceries</option>
          <option value="transport">üöó Transport</option>
          <option value="insurance">üõ°Ô∏è Insurance</option>
          <option value="subscriptions">üì± Subscriptions</option>
          <option value="health">‚ù§Ô∏è Health</option>
          <option value="hoamanagement">üè¢ HOA / Management</option>
          <option value="savings">üí∞ Savings</option>
          <option value="other">üìã Other</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Amount (‚Ç¨)</label>
        <input type="number" id="m-amount" placeholder="120">
      </div>
      <div class="form-group">
        <label>Frequency</label>
        <select id="m-freq">
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
          <option value="quarterly">Quarterly</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea id="m-notes" placeholder="Provider, due date, notes‚Ä¶"></textarea>
    </div>
    <button class="btn-primary" onclick="saveMonthly()">Save Expense</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ -->
<header>
  <div class="header-inner">
    <div class="header-left">
      <h1>Our <em>New Apartment</em></h1>
      <div class="subtitle">Budget Planner &amp; Tracker</div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <div class="db-status">
        <div class="db-dot" id="db-dot"></div>
        <span id="db-label">Connecting‚Ä¶</span>
      </div>
      <div class="edit-toggle-wrap">
        <span id="edit-status" class="locked">üîí View Only</span>
        <button class="btn-lock" id="lock-btn" onclick="toggleEditMode()">Edit Mode</button>
      </div>
    </div>
  </div>
</header>

<nav>
  <div class="nav-inner">
    <button class="active" onclick="showTab('kitchens',this)">üç≥ Kitchens</button>
    <button onclick="showTab('oneoff',this)">üè† One-off Costs</button>
    <button onclick="showTab('loan',this)">üè¶ Loan</button>
    <button onclick="showTab('monthly',this)">üìÖ Monthly</button>
    <button onclick="showTab('overview',this)">üìä Overview</button>
  </div>
</nav>

<main>

<!-- KITCHENS -->
<div id="tab-kitchens" class="tab-content active">
  <div class="section-header">
    <div class="section-title">Kitchen Companies<small>Compare quotes &amp; options</small></div>
    <button class="btn-add edit-only" onclick="openModal('kitchen')" id="btn-add-kitchen">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Company
    </button>
  </div>
  <div class="summary-bar" id="kitchen-summary" style="display:none">
    <div class="sum-item"><div class="sum-label">Companies</div><div class="sum-value" id="ks-count">0</div></div>
    <div class="sum-item"><div class="sum-label">Lowest Quote</div><div class="sum-value gold" id="ks-low">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">Highest Quote</div><div class="sum-value" id="ks-high">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">Favourite</div><div class="sum-value gold" id="ks-fav">‚Äî</div></div>
  </div>
  <div class="cards-grid" id="kitchen-cards"></div>
  <div id="kitchen-empty" class="empty-state">
    <div class="big-icon">üç≥</div>
    <p>No kitchen companies yet.<br>Unlock edit mode to add your first quote.</p>
  </div>
</div>

<!-- ONE-OFF -->
<div id="tab-oneoff" class="tab-content">
  <div class="section-header">
    <div class="section-title">One-off Costs<small>Furniture, renovation, appliances‚Ä¶</small></div>
    <button class="btn-add edit-only" onclick="openModal('oneoff')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Cost
    </button>
  </div>
  <div class="summary-bar" id="oneoff-summary" style="display:none">
    <div class="sum-item"><div class="sum-label">Total Budget</div><div class="sum-value gold" id="os-total">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">Committed / Spent</div><div class="sum-value red" id="os-spent">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">Remaining</div><div class="sum-value green" id="os-rem">‚Äî</div></div>
  </div>
  <div class="expense-list" id="oneoff-list"></div>
  <div id="oneoff-empty" class="empty-state">
    <div class="big-icon">üè†</div>
    <p>No one-off costs yet.<br>Track furniture, appliances, renovation and more.</p>
  </div>
</div>

<!-- LOAN -->
<div id="tab-loan" class="tab-content">
  <div class="section-header">
    <div class="section-title">Mortgage &amp; Loan<small>Track your financing</small></div>
    <button class="btn-add edit-only" onclick="openModal('loan')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add / Edit Loan
    </button>
  </div>
  <div id="loan-cards"></div>
  <div id="loan-empty" class="empty-state">
    <div class="big-icon">üè¶</div>
    <p>No loan details yet.<br>Enter your mortgage or loan information.</p>
  </div>
</div>

<!-- MONTHLY -->
<div id="tab-monthly" class="tab-content">
  <div class="section-header">
    <div class="section-title">Monthly Expenses<small>Recurring costs</small></div>
    <button class="btn-add edit-only" onclick="openModal('monthly')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Expense
    </button>
  </div>
  <div class="summary-bar" id="monthly-summary" style="display:none">
    <div class="sum-item"><div class="sum-label">Total / Month</div><div class="sum-value gold" id="ms-total">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">Total / Year</div><div class="sum-value" id="ms-year">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">Biggest Item</div><div class="sum-value" id="ms-biggest">‚Äî</div></div>
  </div>
  <div id="monthly-chart-wrap" class="chart-wrap" style="display:none">
    <div class="chart-title">Monthly Breakdown</div>
    <div class="bar-chart" id="monthly-chart"></div>
  </div>
  <div class="expense-list" id="monthly-list"></div>
  <div id="monthly-empty" class="empty-state">
    <div class="big-icon">üìÖ</div>
    <p>No monthly expenses yet.<br>Add utilities, subscriptions, food and more.</p>
  </div>
</div>

<!-- OVERVIEW -->
<div id="tab-overview" class="tab-content">
  <div class="section-header">
    <div class="section-title">Financial Overview<small>The full picture</small></div>
  </div>

  <!-- INCOME SECTION -->
  <div class="loan-card" style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
      <h3 style="margin:0;border:none;padding:0;font-family:Cormorant Garamond,serif;font-size:1.3rem;color:var(--blue)">üí∞ Monthly Income</h3>
      <button class="btn-small btn-edit edit-only" onclick="openModal('income')">Edit</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px" id="income-display">
      <div class="loan-stat"><div class="l-label">Your Salary</div><div class="l-val" id="inc-mine">‚Äî</div></div>
      <div class="loan-stat"><div class="l-label">Partner's Salary</div><div class="l-val" id="inc-partner">‚Äî</div></div>
      <div class="loan-stat"><div class="l-label">Combined Net</div><div class="l-val" id="inc-total" style="color:var(--green)">‚Äî</div></div>
    </div>
    <div id="income-empty-hint" style="font-size:0.82rem;color:var(--muted);margin-top:8px;display:none">
      Unlock edit mode to enter your salaries and see how your budget holds up.
    </div>
  </div>

  <!-- BUDGET HEALTH -->
  <div id="budget-health" style="display:none;margin-bottom:20px">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px">
      <div class="sum-item"><div class="sum-label">Total Income</div><div class="sum-value green" id="bh-income">‚Äî</div></div>
      <div class="sum-item"><div class="sum-label">Total Expenses</div><div class="sum-value red" id="bh-expenses">‚Äî</div></div>
      <div class="sum-item"><div class="sum-label">Left After Fixed Costs</div><div class="sum-value" id="bh-leftover">‚Äî</div></div>
      <div class="sum-item"><div class="sum-label">Expenses / Income</div><div class="sum-value" id="bh-pct">‚Äî</div></div>
    </div>
    <!-- HEALTH BAR -->
    <div class="loan-card" style="margin-bottom:0">
      <div style="font-size:0.75rem;font-weight:500;color:var(--muted);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:12px">Budget Allocation</div>
      <div id="budget-bar-wrap" style="height:28px;border-radius:8px;overflow:hidden;display:flex;margin-bottom:10px"></div>
      <div id="budget-bar-legend" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px"></div>
    </div>
  </div>

  <!-- EXISTING SUMMARY -->
  <div class="summary-bar" style="margin-bottom:20px">
    <div class="sum-item"><div class="sum-label">Monthly Expenses</div><div class="sum-value gold" id="ov-monthly">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">Loan Payment</div><div class="sum-value" id="ov-loan">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">Total Monthly</div><div class="sum-value gold" id="ov-total">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">One-off Total</div><div class="sum-value" id="ov-oneoff">‚Äî</div></div>
    <div class="sum-item"><div class="sum-label">Preferred Kitchen</div><div class="sum-value gold" id="ov-kitchen">‚Äî</div></div>
  </div>

  <div class="chart-wrap" id="ov-chart-wrap" style="display:none">
    <div class="chart-title">All Monthly Costs</div>
    <div class="bar-chart" id="overview-chart"></div>
  </div>
  <div class="expense-list" id="overview-list"></div>
</div>

</main>

<!-- INCOME MODAL -->
<div class="modal-overlay" id="modal-income">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('income')">‚úï</button>
    <h2>Monthly Income</h2>
    <p style="font-size:0.82rem;color:var(--muted);margin-bottom:18px">Enter net (after tax) monthly amounts.</p>
    <div class="form-group">
      <label>Your Name</label>
      <input type="text" id="inc-name1" placeholder="e.g. Ant">
    </div>
    <div class="form-group">
      <label>Your Monthly Net Salary (‚Ç¨)</label>
      <input type="number" id="inc-sal1" placeholder="3500">
    </div>
    <div class="form-group">
      <label>Partner's Name</label>
      <input type="text" id="inc-name2" placeholder="e.g. Laura">
    </div>
    <div class="form-group">
      <label>Partner's Monthly Net Salary (‚Ç¨)</label>
      <input type="number" id="inc-sal2" placeholder="2800">
    </div>
    <button class="btn-primary" onclick="saveIncome()">Save Income</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî fill in after Supabase setup, or use setup screen
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EDIT_PASSWORD = '2202';

let SUPABASE_URL = 'https://fsrkkgfkglwcxridednw.supabase.co';
let SUPABASE_KEY = 'sb_publishable_Roq0oIHh98qKU6VcEgGTrw_bbEbEd16';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE CLIENT (vanilla fetch wrapper)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const sb = {
  async query(table, options = {}) {
    let url = `${SUPABASE_URL}/rest/v1/${table}`;
    const params = [];
    if (options.select) params.push(`select=${options.select}`);
    if (options.eq) Object.entries(options.eq).forEach(([k,v]) => params.push(`${k}=eq.${v}`));
    if (options.order) params.push(`order=${options.order}`);
    if (params.length) url += '?' + params.join('&');
    const res = await fetch(url, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Content-Type': 'application/json' }
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  },
  async upsert(table, data) {
    const url = `${SUPABASE_URL}/rest/v1/${table}`;
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates,return=representation'
      },
      body: JSON.stringify(data)
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  },
  async delete(table, id) {
    const url = `${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`;
    const res = await fetch(url, {
      method: 'DELETE',
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
    });
    if (!res.ok) throw new Error(await res.text());
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = { kitchens: [], oneoffs: [], monthly: [], loan: null, income: null };
let editMode = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fmt = n => (n == null || n === '') ? '‚Äî' : '‚Ç¨' + Number(n).toLocaleString('de-DE');
const toMonthly = (amt, freq) => freq === 'yearly' ? amt/12 : freq === 'quarterly' ? amt/3 : amt;
const uid = () => crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36)+Math.random().toString(36).slice(2);
const ICONS = {
  furniture:'üõãÔ∏è', appliances:'üîå', renovation:'üî®', flooring:'üè†',
  lighting:'üí°', textiles:'üõèÔ∏è', storage:'üì¶', other:'üìã',
  utilities:'‚ö°', food:'üõí', transport:'üöó', insurance:'üõ°Ô∏è',
  subscriptions:'üì±', health:'‚ù§Ô∏è', hoamanagement:'üè¢', savings:'üí∞', loan:'üè¶'
};

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2200);
}

function setDbStatus(status, label) {
  const dot = document.getElementById('db-dot');
  const lbl = document.getElementById('db-label');
  dot.className = 'db-dot ' + status;
  lbl.textContent = label;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveSetup() {
  const url = document.getElementById('setup-url').value.trim().replace(/\/$/, '');
  const key = document.getElementById('setup-key').value.trim();
  if (!url || !key) { alert('Please fill in both fields'); return; }
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  SUPABASE_URL = url; SUPABASE_KEY = key;
  document.getElementById('setup-screen').classList.remove('visible');
  init();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT & LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  setDbStatus('', 'Connecting‚Ä¶');
  try {
    const [kitchens, oneoffs, monthly, loanArr, incomeArr] = await Promise.all([
      sb.query('kitchens', { order: 'created_at.asc' }),
      sb.query('oneoffs', { order: 'created_at.asc' }),
      sb.query('monthly', { order: 'created_at.asc' }),
      sb.query('loan', { order: 'created_at.desc' }),
      sb.query('income', { order: 'created_at.desc' })
    ]);
    state.kitchens = kitchens;
    state.oneoffs = oneoffs;
    state.monthly = monthly;
    state.loan = loanArr && loanArr.length ? loanArr[0] : null;
    state.income = incomeArr && incomeArr.length ? incomeArr[0] : null;
    setDbStatus('connected', 'Connected');
    renderAll();
  } catch(e) {
    setDbStatus('error', 'Connection failed');
    console.error(e);
    toast('‚ö†Ô∏è Could not connect to database');
  }
  setTimeout(() => document.getElementById('loading').classList.add('done'), 300);
}

function renderAll() {
  renderKitchens();
  renderOneoff();
  renderLoan();
  renderMonthly();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleEditMode() {
  if (editMode) {
    editMode = false;
    document.body.classList.add('locked');
    document.getElementById('edit-status').className = 'locked';
    document.getElementById('edit-status').textContent = 'üîí View Only';
    document.getElementById('lock-btn').textContent = 'Edit Mode';
    toast('Edit mode off');
  } else {
    openModal('password');
  }
}

function checkPassword() {
  const val = document.getElementById('pw-input').value;
  if (val === EDIT_PASSWORD) {
    closeModal('password');
    document.getElementById('pw-input').value = '';
    document.getElementById('pw-error').style.display = 'none';
    editMode = true;
    document.body.classList.remove('locked');
    document.getElementById('edit-status').className = 'unlocked';
    document.getElementById('edit-status').textContent = '‚úèÔ∏è Editing';
    document.getElementById('lock-btn').textContent = 'Lock';
    toast('Edit mode on ‚Äî changes save instantly');
  } else {
    document.getElementById('pw-error').style.display = 'block';
    document.getElementById('pw-input').value = '';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(t, btn) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + t).classList.add('active');
  btn.classList.add('active');
  if (t === 'overview') renderOverview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(type, id) {
  clearModal(type);
  document.getElementById(`k-edit-id`) && (document.getElementById(`k-edit-id`).value = '');
  if (id) populateModal(type, id);
  if (type === 'kitchen') document.getElementById('kitchen-modal-title').textContent = id ? 'Edit Kitchen Company' : 'Add Kitchen Company';
  if (type === 'oneoff') document.getElementById('oneoff-modal-title').textContent = id ? 'Edit Cost' : 'Add One-off Cost';
  if (type === 'monthly') document.getElementById('monthly-modal-title').textContent = id ? 'Edit Expense' : 'Add Monthly Expense';
  if (type === 'income') populateIncomeModal();
  document.getElementById('modal-' + type).classList.add('open');
  setTimeout(() => { const first = document.querySelector(`#modal-${type} input:not([type=hidden])`); first && first.focus(); }, 100);
}
function closeModal(type) {
  document.getElementById('modal-' + type).classList.remove('open');
  if (type === 'password') { document.getElementById('pw-error').style.display = 'none'; document.getElementById('pw-input').value = ''; }
}
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) { const id = el.id.replace('modal-',''); closeModal(id); } });
});

function clearModal(type) {
  document.querySelectorAll(`#modal-${type} input:not([type=hidden]), #modal-${type} textarea, #modal-${type} select`)
    .forEach(el => { if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; });
}

function populateModal(type, id) {
  if (type === 'kitchen') {
    const item = state.kitchens.find(i => i.id === id); if (!item) return;
    document.getElementById('k-edit-id').value = id;
    document.getElementById('k-name').value = item.name||'';
    document.getElementById('k-logo').value = item.logo||'';
    document.getElementById('k-price').value = item.price||'';
    document.getElementById('k-style').value = item.style||'';
    document.getElementById('k-notes').value = item.notes||'';
    document.getElementById('k-contact').value = item.contact||'';
    document.getElementById('k-website').value = item.website||'';
  } else if (type === 'oneoff') {
    const item = state.oneoffs.find(i => i.id === id); if (!item) return;
    document.getElementById('o-edit-id').value = id;
    document.getElementById('o-name').value = item.name||'';
    document.getElementById('o-cat').value = item.cat||'other';
    document.getElementById('o-budget').value = item.budget||'';
    document.getElementById('o-actual').value = item.actual||'';
    document.getElementById('o-notes').value = item.notes||'';
  } else if (type === 'loan') {
    const item = state.loan; if (!item) return;
    document.getElementById('l-name').value = item.name||'';
    document.getElementById('l-amount').value = item.amount||'';
    document.getElementById('l-monthly').value = item.monthly||'';
    document.getElementById('l-rate').value = item.rate||'';
    document.getElementById('l-term').value = item.term||'';
    document.getElementById('l-paid').value = item.paid||'';
    document.getElementById('l-notes').value = item.notes||'';
  } else if (type === 'monthly') {
    const item = state.monthly.find(i => i.id === id); if (!item) return;
    document.getElementById('m-edit-id').value = id;
    document.getElementById('m-name').value = item.name||'';
    document.getElementById('m-cat').value = item.cat||'other';
    document.getElementById('m-amount').value = item.amount||'';
    document.getElementById('m-freq').value = item.freq||'monthly';
    document.getElementById('m-notes').value = item.notes||'';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KITCHENS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveKitchen() {
  const editId = document.getElementById('k-edit-id').value;
  const item = {
    id: editId || uid(),
    name: document.getElementById('k-name').value.trim(),
    logo: document.getElementById('k-logo').value.trim(),
    price: parseFloat(document.getElementById('k-price').value) || null,
    style: document.getElementById('k-style').value.trim(),
    notes: document.getElementById('k-notes').value.trim(),
    contact: document.getElementById('k-contact').value.trim(),
    website: document.getElementById('k-website').value.trim(),
    favorite: editId ? (state.kitchens.find(i=>i.id===editId)||{}).favorite||false : false
  };
  if (!item.name) { alert('Please enter a company name'); return; }
  setDbStatus('saving', 'Saving‚Ä¶');
  try {
    await sb.upsert('kitchens', item);
    if (editId) state.kitchens = state.kitchens.map(i => i.id===editId ? item : i);
    else state.kitchens.push(item);
    setDbStatus('connected', 'Saved ‚úì');
    closeModal('kitchen');
    renderKitchens();
    toast('Kitchen company saved');
  } catch(e) { setDbStatus('error','Save failed'); toast('‚ö†Ô∏è Save failed'); console.error(e); }
}

async function toggleFavorite(id) {
  const item = state.kitchens.find(i=>i.id===id); if (!item) return;
  const newFav = !item.favorite;
  setDbStatus('saving','Saving‚Ä¶');
  try {
    // unfav all others first
    const promises = state.kitchens.map(k => {
      const updated = {...k, favorite: k.id===id ? newFav : false};
      return sb.upsert('kitchens', updated).then(() => { state.kitchens = state.kitchens.map(x=>x.id===k.id?updated:x); });
    });
    await Promise.all(promises);
    setDbStatus('connected','Saved ‚úì');
    renderKitchens();
  } catch(e) { setDbStatus('error','Save failed'); toast('‚ö†Ô∏è Save failed'); }
}

async function deleteKitchen(id) {
  if (!confirm('Delete this company?')) return;
  setDbStatus('saving','Saving‚Ä¶');
  try {
    await sb.delete('kitchens', id);
    state.kitchens = state.kitchens.filter(i=>i.id!==id);
    setDbStatus('connected','Saved ‚úì');
    renderKitchens(); toast('Deleted');
  } catch(e) { setDbStatus('error','Delete failed'); toast('‚ö†Ô∏è Delete failed'); }
}

function renderKitchens() {
  const items = state.kitchens;
  const container = document.getElementById('kitchen-cards');
  const empty = document.getElementById('kitchen-empty');
  const summary = document.getElementById('kitchen-summary');
  if (!items.length) { container.innerHTML=''; empty.style.display=''; summary.style.display='none'; return; }
  empty.style.display='none'; summary.style.display='';
  const prices = items.filter(i=>i.price).map(i=>i.price);
  document.getElementById('ks-count').textContent = items.length;
  document.getElementById('ks-low').textContent = prices.length ? fmt(Math.min(...prices)) : '‚Äî';
  document.getElementById('ks-high').textContent = prices.length ? fmt(Math.max(...prices)) : '‚Äî';
  const fav = items.find(i=>i.favorite);
  document.getElementById('ks-fav').textContent = fav ? fav.name : '‚Äî';
  container.innerHTML = items.map(item => {
    const initials = item.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    const logoHtml = item.logo
      ? `<img src="${item.logo}" onerror="this.style.display='none';this.nextSibling.style.display='flex'" alt=""><span class="initials" style="display:none">${initials}</span>`
      : `<span class="initials">${initials}</span>`;
    return `<div class="card">
      ${item.favorite ? '<div class="badge-fav">‚òÖ Favourite</div>' : ''}
      <div class="card-header">
        <div class="company-logo">${logoHtml}</div>
        <div>
          <div class="card-name">${item.name}</div>
          <div class="card-tag">${item.style||'Kitchen'}</div>
        </div>
      </div>
      <div class="card-body">
        <div class="price-row">
          <span class="price-label">Quote</span>
          <span class="price-value">${fmt(item.price)}</span>
        </div>
        ${item.contact?`<div class="price-row"><span class="price-label">Contact</span><span style="font-size:0.82rem;color:var(--text)">${item.contact}</span></div>`:''}
        ${item.website?`<div class="price-row"><span class="price-label">Website</span><a href="${item.website}" target="_blank" style="font-size:0.8rem;color:var(--gold);text-decoration:none">${item.website.replace(/^https?:\/\//,'')}</a></div>`:''}
        ${item.notes?`<div class="note-text">${item.notes}</div>`:''}
      </div>
      <div class="card-actions">
        <button class="btn-small btn-edit edit-only" onclick="openModal('kitchen','${item.id}')">Edit</button>
        <button class="btn-small btn-delete edit-only" onclick="deleteKitchen('${item.id}')">Delete</button>
        <button class="btn-small btn-fav edit-only ${item.favorite?'active':''}" onclick="toggleFavorite('${item.id}')">${item.favorite?'‚òÖ Favourite':'‚òÜ Favourite'}</button>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONE-OFF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveOneoff() {
  const editId = document.getElementById('o-edit-id').value;
  const item = {
    id: editId || uid(),
    name: document.getElementById('o-name').value.trim(),
    cat: document.getElementById('o-cat').value,
    budget: parseFloat(document.getElementById('o-budget').value)||null,
    actual: parseFloat(document.getElementById('o-actual').value)||null,
    notes: document.getElementById('o-notes').value.trim()
  };
  if (!item.name) { alert('Please enter a name'); return; }
  setDbStatus('saving','Saving‚Ä¶');
  try {
    await sb.upsert('oneoffs', item);
    if (editId) state.oneoffs = state.oneoffs.map(i=>i.id===editId?item:i);
    else state.oneoffs.push(item);
    setDbStatus('connected','Saved ‚úì');
    closeModal('oneoff'); renderOneoff(); toast('Cost saved');
  } catch(e) { setDbStatus('error','Save failed'); toast('‚ö†Ô∏è Save failed'); }
}

async function deleteOneoff(id) {
  if (!confirm('Delete this item?')) return;
  setDbStatus('saving','Saving‚Ä¶');
  try {
    await sb.delete('oneoffs', id);
    state.oneoffs = state.oneoffs.filter(i=>i.id!==id);
    setDbStatus('connected','Saved ‚úì'); renderOneoff(); toast('Deleted');
  } catch(e) { setDbStatus('error','Delete failed'); }
}

function renderOneoff() {
  const items = state.oneoffs;
  const container = document.getElementById('oneoff-list');
  const empty = document.getElementById('oneoff-empty');
  const summary = document.getElementById('oneoff-summary');
  if (!items.length) { container.innerHTML=''; empty.style.display=''; summary.style.display='none'; return; }
  empty.style.display='none'; summary.style.display='';
  const totalBudget = items.reduce((s,i)=>s+(i.budget||0),0);
  const totalActual = items.reduce((s,i)=>s+(i.actual||0),0);
  document.getElementById('os-total').textContent = fmt(totalBudget);
  document.getElementById('os-spent').textContent = fmt(totalActual);
  const rem = totalBudget - totalActual;
  const remEl = document.getElementById('os-rem');
  remEl.textContent = fmt(rem); remEl.className = 'sum-value '+(rem>=0?'green':'red');
  container.innerHTML = items.map(item=>`
    <div class="expense-item">
      <div class="expense-icon">${ICONS[item.cat]||'üìã'}</div>
      <div class="expense-info">
        <div class="expense-name">${item.name}</div>
        <div class="expense-cat">${item.cat}</div>
        ${item.notes?`<div style="font-size:0.76rem;color:var(--muted);margin-top:3px">${item.notes}</div>`:''}
      </div>
      <div style="text-align:right;min-width:130px">
        ${item.actual!=null?`<div class="expense-amount" style="font-size:1.1rem">${fmt(item.actual)}<span class="expense-freq">actual</span></div>`:''}
        ${item.budget!=null?`<div style="font-size:0.78rem;color:var(--muted)">${fmt(item.budget)} budget</div>`:''}
      </div>
      <div class="item-actions edit-only">
        <button class="btn-small btn-edit" onclick="openModal('oneoff','${item.id}')">Edit</button>
        <button class="btn-small btn-delete" onclick="deleteOneoff('${item.id}')">Del</button>
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveLoan() {
  const existing = state.loan;
  const item = {
    id: existing ? existing.id : uid(),
    name: document.getElementById('l-name').value.trim(),
    amount: parseFloat(document.getElementById('l-amount').value)||null,
    monthly: parseFloat(document.getElementById('l-monthly').value)||null,
    rate: parseFloat(document.getElementById('l-rate').value)||null,
    term: parseInt(document.getElementById('l-term').value)||null,
    paid: parseFloat(document.getElementById('l-paid').value)||0,
    notes: document.getElementById('l-notes').value.trim()
  };
  setDbStatus('saving','Saving‚Ä¶');
  try {
    await sb.upsert('loan', item);
    state.loan = item;
    setDbStatus('connected','Saved ‚úì');
    closeModal('loan'); renderLoan(); toast('Loan details saved');
  } catch(e) { setDbStatus('error','Save failed'); toast('‚ö†Ô∏è Save failed'); }
}

function renderLoan() {
  const loan = state.loan;
  const container = document.getElementById('loan-cards');
  const empty = document.getElementById('loan-empty');
  if (!loan) { container.innerHTML=''; empty.style.display=''; return; }
  empty.style.display='none';
  const paidPct = loan.amount ? Math.min(100,(loan.paid/loan.amount*100)).toFixed(1) : 0;
  const remaining = loan.amount ? loan.amount - loan.paid : null;
  container.innerHTML = `<div class="loan-card">
    <h3>${loan.name||'Mortgage'}</h3>
    <div class="loan-details">
      <div class="loan-stat"><div class="l-label">Total Loan</div><div class="l-val">${fmt(loan.amount)}</div></div>
      <div class="loan-stat"><div class="l-label">Monthly Payment</div><div class="l-val">${fmt(loan.monthly)}</div></div>
      <div class="loan-stat"><div class="l-label">Interest Rate</div><div class="l-val">${loan.rate?loan.rate+'%':'‚Äî'}</div></div>
      <div class="loan-stat"><div class="l-label">Term</div><div class="l-val">${loan.term?loan.term+' yr':'‚Äî'}</div></div>
      <div class="loan-stat"><div class="l-label">Paid So Far</div><div class="l-val">${fmt(loan.paid)}</div></div>
      <div class="loan-stat"><div class="l-label">Remaining</div><div class="l-val">${fmt(remaining)}</div></div>
    </div>
    ${loan.amount&&loan.paid?`<div class="progress-wrap">
      <div class="progress-label"><span>Paid off</span><span>${paidPct}%</span></div>
      <div class="progress-bar"><div class="progress-fill" style="width:${paidPct}%"></div></div>
    </div>`:''}
    ${loan.notes?`<div class="note-text" style="margin-top:14px">${loan.notes}</div>`:''}
    <div style="margin-top:16px" class="edit-only">
      <button class="btn-small btn-edit" onclick="openModal('loan','edit')">Edit Loan</button>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MONTHLY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveMonthly() {
  const editId = document.getElementById('m-edit-id').value;
  const item = {
    id: editId || uid(),
    name: document.getElementById('m-name').value.trim(),
    cat: document.getElementById('m-cat').value,
    amount: parseFloat(document.getElementById('m-amount').value)||null,
    freq: document.getElementById('m-freq').value,
    notes: document.getElementById('m-notes').value.trim()
  };
  if (!item.name) { alert('Please enter a name'); return; }
  setDbStatus('saving','Saving‚Ä¶');
  try {
    await sb.upsert('monthly', item);
    if (editId) state.monthly = state.monthly.map(i=>i.id===editId?item:i);
    else state.monthly.push(item);
    setDbStatus('connected','Saved ‚úì');
    closeModal('monthly'); renderMonthly(); toast('Expense saved');
  } catch(e) { setDbStatus('error','Save failed'); toast('‚ö†Ô∏è Save failed'); }
}

async function deleteMonthly(id) {
  if (!confirm('Delete this expense?')) return;
  setDbStatus('saving','Saving‚Ä¶');
  try {
    await sb.delete('monthly', id);
    state.monthly = state.monthly.filter(i=>i.id!==id);
    setDbStatus('connected','Saved ‚úì'); renderMonthly(); toast('Deleted');
  } catch(e) { setDbStatus('error','Delete failed'); }
}

function renderMonthly() {
  const items = state.monthly;
  const container = document.getElementById('monthly-list');
  const empty = document.getElementById('monthly-empty');
  const summary = document.getElementById('monthly-summary');
  const chartWrap = document.getElementById('monthly-chart-wrap');
  if (!items.length) { container.innerHTML=''; empty.style.display=''; summary.style.display='none'; chartWrap.style.display='none'; return; }
  empty.style.display='none'; summary.style.display=''; chartWrap.style.display='';
  const totalMonthly = items.reduce((s,i)=>s+toMonthly(i.amount||0,i.freq),0);
  const biggest = items.reduce((a,b)=>toMonthly(a.amount||0,a.freq)>toMonthly(b.amount||0,b.freq)?a:b);
  document.getElementById('ms-total').textContent = fmt(Math.round(totalMonthly));
  document.getElementById('ms-year').textContent = fmt(Math.round(totalMonthly*12));
  document.getElementById('ms-biggest').textContent = biggest.name;
  const maxAmt = Math.max(...items.map(i=>toMonthly(i.amount||0,i.freq)));
  document.getElementById('monthly-chart').innerHTML = items.map(i=>{
    const m = toMonthly(i.amount||0,i.freq);
    const pct = maxAmt?(m/maxAmt*100):0;
    return `<div class="bar-item"><div class="bar-val">${fmt(Math.round(m))}</div><div class="bar" style="height:${pct}%"></div><div class="bar-label">${i.name.slice(0,9)}</div></div>`;
  }).join('');
  container.innerHTML = items.map(item=>`
    <div class="expense-item">
      <div class="expense-icon">${ICONS[item.cat]||'üìã'}</div>
      <div class="expense-info">
        <div class="expense-name">${item.name}</div>
        <div class="expense-cat">${item.cat} ¬∑ ${item.freq}</div>
        ${item.notes?`<div style="font-size:0.76rem;color:var(--muted);margin-top:3px">${item.notes}</div>`:''}
      </div>
      <div class="expense-amount">${fmt(item.amount)}<span class="expense-freq">${item.freq}</span></div>
      <div class="item-actions edit-only">
        <button class="btn-small btn-edit" onclick="openModal('monthly','${item.id}')">Edit</button>
        <button class="btn-small btn-delete" onclick="deleteMonthly('${item.id}')">Del</button>
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INCOME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveIncome() {
  const item = {
    id: state.income ? state.income.id : uid(),
    name1: document.getElementById('inc-name1').value.trim() || 'You',
    sal1: parseFloat(document.getElementById('inc-sal1').value) || null,
    name2: document.getElementById('inc-name2').value.trim() || 'Partner',
    sal2: parseFloat(document.getElementById('inc-sal2').value) || null,
  };
  setDbStatus('saving','Saving‚Ä¶');
  try {
    await sb.upsert('income', item);
    state.income = item;
    setDbStatus('connected','Saved ‚úì');
    closeModal('income');
    renderOverview();
    toast('Income saved');
  } catch(e) { setDbStatus('error','Save failed'); toast('‚ö†Ô∏è Save failed'); console.error(e); }
}

function renderIncomeSection() {
  const inc = state.income;
  if (!inc) {
    document.getElementById('inc-mine').textContent = '‚Äî';
    document.getElementById('inc-partner').textContent = '‚Äî';
    document.getElementById('inc-total').textContent = '‚Äî';
    document.getElementById('income-empty-hint').style.display = editMode ? '' : 'block';
    return;
  }
  document.getElementById('income-empty-hint').style.display = 'none';
  // Update labels dynamically with names
  const labels = document.querySelectorAll('#income-display .l-label');
  if (labels[0]) labels[0].textContent = (inc.name1 || 'You') + "'s Salary";
  if (labels[1]) labels[1].textContent = (inc.name2 || 'Partner') + "'s Salary";
  document.getElementById('inc-mine').textContent = fmt(inc.sal1);
  document.getElementById('inc-partner').textContent = fmt(inc.sal2);
  const total = (inc.sal1||0) + (inc.sal2||0);
  document.getElementById('inc-total').textContent = total ? fmt(total) : '‚Äî';
}

function populateIncomeModal() {
  const inc = state.income;
  if (!inc) return;
  document.getElementById('inc-name1').value = inc.name1 || '';
  document.getElementById('inc-sal1').value = inc.sal1 || '';
  document.getElementById('inc-name2').value = inc.name2 || '';
  document.getElementById('inc-sal2').value = inc.sal2 || '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOverview() {
  const monthly = state.monthly;
  const oneoffs = state.oneoffs;
  const loan = state.loan;
  const kitchens = state.kitchens;
  const inc = state.income;

  const totalMonthly = monthly.reduce((s,i)=>s+toMonthly(i.amount||0,i.freq),0);
  const totalOneoff = oneoffs.reduce((s,i)=>s+(i.actual||i.budget||0),0);
  const fav = kitchens.find(k=>k.favorite)||kitchens[0];
  const loanMonthly = loan&&loan.monthly ? loan.monthly : 0;
  const grandTotal = totalMonthly + loanMonthly;

  // summary bar
  document.getElementById('ov-monthly').textContent = fmt(Math.round(totalMonthly));
  document.getElementById('ov-loan').textContent = loanMonthly ? fmt(loanMonthly)+'/mo' : '‚Äî';
  document.getElementById('ov-total').textContent = fmt(Math.round(grandTotal));
  document.getElementById('ov-oneoff').textContent = fmt(totalOneoff);
  document.getElementById('ov-kitchen').textContent = fav ? fav.name : '‚Äî';

  // income section
  renderIncomeSection();

  // budget health
  const totalIncome = inc ? (inc.sal1||0) + (inc.sal2||0) : 0;
  const healthEl = document.getElementById('budget-health');
  if (totalIncome > 0 && grandTotal > 0) {
    healthEl.style.display = '';
    const leftover = totalIncome - grandTotal;
    const pct = Math.round(grandTotal / totalIncome * 100);
    document.getElementById('bh-income').textContent = fmt(Math.round(totalIncome));
    document.getElementById('bh-expenses').textContent = fmt(Math.round(grandTotal));
    const leftEl = document.getElementById('bh-leftover');
    leftEl.textContent = fmt(Math.round(leftover));
    leftEl.className = 'sum-value ' + (leftover >= 0 ? 'green' : 'red');
    document.getElementById('bh-pct').textContent = pct + '%';

    // stacked bar: loan | monthly | leftover
    const loanPct = totalIncome ? (loanMonthly / totalIncome * 100) : 0;
    const monthlyPct = totalIncome ? (totalMonthly / totalIncome * 100) : 0;
    const leftPct = Math.max(0, 100 - loanPct - monthlyPct);
    const segments = [
      { label: loan ? (loan.name||'Loan') : 'Loan', pct: loanPct, color: '#c0392b' },
      { label: 'Monthly expenses', pct: monthlyPct, color: '#1a3a6b' },
      { label: 'Left over', pct: leftPct, color: leftover >= 0 ? '#1a7a4a' : '#e74c3c' },
    ].filter(s => s.pct > 0);
    document.getElementById('budget-bar-wrap').innerHTML = segments.map(s =>
      `<div style="width:${s.pct.toFixed(1)}%;background:${s.color};transition:width 0.5s;display:flex;align-items:center;justify-content:center">
        ${s.pct > 8 ? `<span style="font-size:0.65rem;color:white;font-weight:500;white-space:nowrap">${s.pct.toFixed(0)}%</span>` : ''}
      </div>`
    ).join('');
    document.getElementById('budget-bar-legend').innerHTML = segments.map(s =>
      `<div style="display:flex;align-items:center;gap:5px;font-size:0.72rem;color:var(--muted)">
        <div style="width:10px;height:10px;border-radius:2px;background:${s.color};flex-shrink:0"></div>
        ${s.label}
      </div>`
    ).join('');
  } else {
    healthEl.style.display = 'none';
  }

  // chart & breakdown
  const allItems = [...monthly.map(i=>({...i,isLoan:false}))];
  if (loan&&loan.monthly) allItems.push({name:loan.name||'Loan',cat:'loan',amount:loan.monthly,freq:'monthly',isLoan:true});
  if (!allItems.length) { document.getElementById('ov-chart-wrap').style.display='none'; document.getElementById('overview-list').innerHTML=''; return; }
  document.getElementById('ov-chart-wrap').style.display='';
  const maxAmt = Math.max(...allItems.map(i=>toMonthly(i.amount||0,i.freq)));
  document.getElementById('overview-chart').innerHTML = allItems.map(i=>{
    const m = toMonthly(i.amount||0,i.freq);
    const pct = maxAmt?(m/maxAmt*100):0;
    return `<div class="bar-item"><div class="bar-val" style="font-size:0.6rem">${fmt(Math.round(m))}</div><div class="bar ${i.isLoan?'loan-bar':''}" style="height:${pct}%"></div><div class="bar-label">${i.name.slice(0,9)}</div></div>`;
  }).join('');
  document.getElementById('overview-list').innerHTML = `<div class="loan-card">
    <h3>Monthly Breakdown</h3>
    ${allItems.map(i=>{
      const m=Math.round(toMonthly(i.amount||0,i.freq));
      const pct=grandTotal?(m/grandTotal*100).toFixed(0):0;
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border)">
        <span style="display:flex;align-items:center;gap:8px">${ICONS[i.cat]||'üìã'} <span style="font-size:0.9rem">${i.name}</span></span>
        <span style="display:flex;align-items:center;gap:14px">
          <span style="font-size:0.7rem;color:var(--muted)">${pct}%</span>
          <span style="font-family:Cormorant Garamond,serif;font-size:1.1rem;color:var(--blue2)">${fmt(m)}</span>
        </span>
      </div>`;
    }).join('')}
    <div style="display:flex;justify-content:space-between;padding:14px 0 0;font-family:Cormorant Garamond,serif;font-size:1.4rem;color:var(--blue)">
      <span>Total / month</span><span style="color:var(--red)">${fmt(Math.round(grandTotal))}</span>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KICK OFF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
init();
</script>
</body>
</html>
